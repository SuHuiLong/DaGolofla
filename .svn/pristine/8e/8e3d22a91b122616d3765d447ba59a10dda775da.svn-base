//
//  PostDataRequest.m
//  CharmRiuJin
//
//  Created by bhxx on 15/6/16.
//  Copyright (c) 2015年 bhxx. All rights reserved.

#define urlStr [NSString stringWithFormat:@"http://139.196.9.49:8081/dagaoerfu/%@",port]
//#define urlStr [NSString stringWithFormat:@"http://192.168.2.250:8080/dagaoerfu/%@",port]
//#define urlStr [NSString stringWithFormat:@"http://xiaoar.oicp.net:16681/dagaoerfu/%@",port]
//#define urlStr [NSString stringWithFormat:@"http://192.168.2.38:8088/dagaoerfu/%@",port]


#import "PostDataRequest.h"
#import "AFNetworking.h"
#import "Helper.h"
@implementation PostDataRequest
{
    AFHTTPRequestOperationManager *_httpManager;
}

+ (instancetype)sharedInstance {
    static PostDataRequest *s_engine = nil;
    static dispatch_once_t onceToken;
    dispatch_once(&onceToken, ^{
        s_engine = [[PostDataRequest alloc] init];
    });
    return s_engine;
}

- (id)init {
    if (self = [super init]) {
        _httpManager = [[AFHTTPRequestOperationManager alloc] init];
        //返回二进制
        _httpManager.responseSerializer = [AFHTTPResponseSerializer serializer];
    }
    return self;
}

- (void)postDataRequest:(NSString *)port parameter:(NSDictionary *)dit success:(SuccessBlockType)successBlock failed:(FailedBlockType)faliedBlock{
    
    //设置请求超时
    
    _httpManager.responseSerializer.acceptableContentTypes = [NSSet setWithObject:@"text/html"];
    
    [_httpManager POST:urlStr parameters:dit success:^(AFHTTPRequestOperation *operation, id responseObject) {
        if (successBlock) {
            successBlock(responseObject);
        }
    } failure:^(AFHTTPRequestOperation *operation, NSError *error) {
        if ([[error.userInfo objectForKey:@"_kCFStreamErrorCodeKey"] integerValue] == 60) {
            [Helper downLoadDataOverrun];
        }else if ([[error.userInfo objectForKey:@"_kCFStreamErrorCodeKey"] integerValue] == 61) {
            [Helper netWorkError];
        }
        if (faliedBlock) {
            faliedBlock(error);
        }
    }];
}

- (void)postDataAndImageRequest:(NSString *)port parameter:(NSDictionary *)dit imageDataArr:(NSArray *)imageDataArr success:(SuccessBlockType)successBlock failed:(FailedBlockType)faliedBlock {
    
    //设置请求超时
    
    _httpManager.responseSerializer.acceptableContentTypes = [NSSet setWithObject:@"text/html"];
    
    [_httpManager POST:urlStr parameters:dit constructingBodyWithBlock:^(id<AFMultipartFormData> formData) {
        for (int i = 0; i <imageDataArr.count; i++) {
            NSDateFormatter *formatter = [[NSDateFormatter alloc] init];
            // 设置日期格式
            formatter.dateFormat = @"yyyy-MM-dd HH:mm:ss";
            NSString *fileName = [formatter stringFromDate:[NSDate date]];
            NSString *nameStr = @"myPic";
            
            [formData appendPartWithFileData:imageDataArr[i] name:nameStr fileName:[NSString stringWithFormat:@"%@.png",fileName] mimeType:@"image/png"];
        }
    } success:^(AFHTTPRequestOperation *operation, id responseObject) {
        if (successBlock) {
            successBlock(responseObject);
        }
    } failure:^(AFHTTPRequestOperation *operation, NSError *error) {
        if ([[error.userInfo objectForKey:@"_kCFStreamErrorCodeKey"] integerValue] == 60) {
            [Helper downLoadDataOverrun];
        }else if ([[error.userInfo objectForKey:@"_kCFStreamErrorCodeKey"] integerValue] == 51) {
            [Helper netWorkError];
        }
        if (faliedBlock) {
            faliedBlock(error);
        }
    }];
}
- (void)postOpenBusinessData:(NSString *)port parameter:(NSDictionary *)dit imageDataArr:(NSArray *)imageDataArr success:(SuccessBlockType)successBlock failed:(FailedBlockType)faliedBlock {
    _httpManager.responseSerializer.acceptableContentTypes = [NSSet setWithObject:@"text/html"];
    [_httpManager POST:urlStr parameters:dit constructingBodyWithBlock:^(id<AFMultipartFormData> formData) {
        for (int i = 0; i <imageDataArr.count; i++) {
            NSDateFormatter *formatter = [[NSDateFormatter alloc] init];
            // 设置日期格式
            formatter.dateFormat = @"yyyy-MM-dd HH:mm:ss";
            NSString *fileName = [formatter stringFromDate:[NSDate date]];
            [formData appendPartWithFileData:imageDataArr[i] name:@"myPic" fileName:[NSString stringWithFormat:@"%@.png",fileName] mimeType:@"image/png"];
        }
    } success:^(AFHTTPRequestOperation *operation, id responseObject) {
        if (successBlock) {
            successBlock(responseObject);
        }
    } failure:^(AFHTTPRequestOperation *operation, NSError *error) {
        if ([[error.userInfo objectForKey:@"_kCFStreamErrorCodeKey"] integerValue] == 60) {
            [Helper downLoadDataOverrun];
        }else if ([[error.userInfo objectForKey:@"_kCFStreamErrorCodeKey"] integerValue] == 51) {
            [Helper netWorkError];
        }
        if (faliedBlock) {
            faliedBlock(error);
        }
    }];
}
- (void)getDataRequest:(NSString *)port success:(SuccessBlockType)successBlock failed:(FailedBlockType)faliedBlock{
    
    [_httpManager GET:port parameters:nil success:^(AFHTTPRequestOperation *operation, id responseObject) {
        if (successBlock) {
            successBlock(responseObject);
        }
    } failure:^(AFHTTPRequestOperation *operation, NSError *error) {
        if ([[error.userInfo objectForKey:@"_kCFStreamErrorCodeKey"] integerValue] == 60) {
            [Helper downLoadDataOverrun];
        }else if ([[error.userInfo objectForKey:@"_kCFStreamErrorCodeKey"] integerValue] == 61) {
            [Helper netWorkError];
        }
        if (faliedBlock) {
            faliedBlock(error);
        }
    }];
}

- (void)postDataAndImageRequestBackPic:(NSString *)port parameter:(NSDictionary *)dit imageDataArr:(NSArray *)imageDataArr success:(SuccessBlockType)successBlock failed:(FailedBlockType)faliedBlock {
    _httpManager.responseSerializer.acceptableContentTypes = [NSSet setWithObject:@"text/html"];
    [_httpManager POST:urlStr parameters:dit constructingBodyWithBlock:^(id<AFMultipartFormData> formData) {
        for (int i = 0; i <imageDataArr.count; i++) {
            NSDateFormatter *formatter = [[NSDateFormatter alloc] init];
            // 设置日期格式
            formatter.dateFormat = @"yyyy-MM-dd HH:mm:ss";
            NSString *fileName = [formatter stringFromDate:[NSDate date]];
            NSString *nameStr = @"backPic";
            
            [formData appendPartWithFileData:imageDataArr[i] name:nameStr fileName:[NSString stringWithFormat:@"%@.png",fileName] mimeType:@"image/png"];
        }
    } success:^(AFHTTPRequestOperation *operation, id responseObject) {
        if (successBlock) {
            successBlock(responseObject);
        }
    } failure:^(AFHTTPRequestOperation *operation, NSError *error) {
        if ([[error.userInfo objectForKey:@"_kCFStreamErrorCodeKey"] integerValue] == 60) {
            [Helper downLoadDataOverrun];
        }else if ([[error.userInfo objectForKey:@"_kCFStreamErrorCodeKey"] integerValue] == 51) {
            [Helper netWorkError];
        }
        if (faliedBlock) {
            faliedBlock(error);
        }
    }];
}





















@end
